name: Docker Build Verification

on:
  push:
    branches:
      - main
      - 'copilot/**'
    paths:
      - 'main.pl'
      - 'Dockerfile'
      - '.github/workflows/docker-build.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'main.pl'
      - 'Dockerfile'
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          echo "üî® Building Docker image..."
          docker build -t job-ready-backend:test .
          echo "‚úÖ Docker build successful!"
      
      - name: Start Docker container
        run: |
          echo "üöÄ Starting Docker container..."
          docker run -d --name test-backend -p 8080:8080 job-ready-backend:test
          echo "‚è≥ Waiting for backend to start..."
          sleep 10
      
      - name: Check container health
        run: |
          echo "üîç Checking container status..."
          docker ps -a | grep test-backend
          
          if ! docker ps | grep -q test-backend; then
            echo "‚ùå Container is not running!"
            echo "üìã Container logs:"
            docker logs test-backend
            exit 1
          fi
          
          echo "‚úÖ Container is running!"
      
      - name: Test health endpoint
        run: |
          echo "üîç Testing health endpoint..."
          
          MAX_RETRIES=5
          RETRY=0
          
          while [ $RETRY -lt $MAX_RETRIES ]; do
            RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/api/health || echo "000")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed!"
              echo "Response: $(echo "$RESPONSE" | sed '$d')"
              break
            fi
            
            RETRY=$((RETRY + 1))
            echo "‚è≥ Attempt $RETRY/$MAX_RETRIES failed (code: $HTTP_CODE), retrying..."
            sleep 5
          done
          
          if [ $RETRY -eq $MAX_RETRIES ]; then
            echo "‚ùå Health check failed after $MAX_RETRIES attempts"
            echo "üìã Container logs:"
            docker logs test-backend
            exit 1
          fi
      
      - name: Test API endpoints
        run: |
          echo "üîç Testing career paths endpoint..."
          RESPONSE=$(curl -s -w "\n%{http_code}" http://localhost:8080/api/career-paths)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Career paths endpoint working!"
            BODY=$(echo "$RESPONSE" | sed '$d')
            echo "Found $(echo "$BODY" | grep -o '"id"' | wc -l) career paths"
          else
            echo "‚ùå Career paths endpoint failed with code: $HTTP_CODE"
            exit 1
          fi
      
      - name: Test CORS headers
        run: |
          echo "üîç Testing CORS configuration..."
          RESPONSE=$(curl -s -i -H "Origin: https://job-ready-learner.vercel.app" http://localhost:8080/api/career-paths)
          
          if echo "$RESPONSE" | grep -q "Access-Control-Allow-Origin"; then
            echo "‚úÖ CORS headers present!"
            echo "$RESPONSE" | grep "Access-Control"
          else
            echo "‚ö†Ô∏è Warning: CORS headers not found"
          fi
      
      - name: Show container logs
        if: always()
        run: |
          echo "üìã Container logs:"
          docker logs test-backend
      
      - name: Cleanup
        if: always()
        run: |
          docker stop test-backend || true
          docker rm test-backend || true
      
      - name: Summary
        if: success()
        run: |
          echo "üéâ All Docker build and tests passed!"
          echo "‚úÖ Docker image builds successfully"
          echo "‚úÖ Backend starts and responds correctly"
          echo "‚úÖ API endpoints are working"
          echo "‚úÖ CORS is configured"
